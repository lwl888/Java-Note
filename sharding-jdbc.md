## 一、基本功能介绍 

-------------------------------------------------------------------------

### 1.1、数据分片



#### 1.1.1、存储横向扩展

```
扩展容量，数据扩展到多台存储服务器，带来的问题，解决计算分布，数据0传输
```

#### 1.1.2、计算横向扩展

```
扩展计算资源，通过多个节点共同处理同一份资源，提高数据的处理效率
```

#### 1.1.3、什么是分布式

```
存储分布式 + 计算分布式
```

#### 1.1.4、什么是分布式数据库

```
数据库是“按照一定的数据结构来组织、存储和管理数据的仓库”。是一个长期存储在计算机内的、有组织的、可共享的、统一管理的大量数据的集合，分布式再数据库的基础上动态扩展了存储能力和计算能力
```

#### 1.1.5、Sharding-JDBC

```
该框架属于分布式数据库的客户端实现，通过规则配置和数据分片，可以利用多数据库节点，在逻辑上组成分布式数据库
```

​	

-------------------------------------------------------------------------



### 1.2、数据加解密方法



#### 1.2.1、代理服务层

	Sharding-Proxy，MyCat

#### 1.2.2、Connector 层处理

	装饰DataSource 解析Sql，渲染数据

#### 1.2.3、扩展特定框架

	扩展Mybaties，扩展Hibernate

#### 1.2.4、编写业务代码

	嵌入加解密代码或约定基础框架实现，例如使用工具类，编写基础的BaseDao数据访问层

#### 1.2.5、使用商业产品

```yaml
                                 Config

                                   ^
                                   |

                                   | 

Mysql                              |                       SpringBoot

SqlServer .............. Proxy（加解密+脱敏）..............  Application               

Oracle                                                     Tomcat

```



#### 1.2.6、选择什么方法

```
高性能 + 稳定性 + 成本(时间、费用)低
```



-------------------------------------------------------------------------





## 二、数据库分片实现





-------------------------------------------------------------------------

### 2.1、数据分片



#### 2.1.1、单库多表实现

```yaml
分表策略：单字段Hash算法，多字段复杂算法

ds:
  -table_1
  .
  .
  .
  -table_N

ShardingRule: 

	TableRule: XXXXXXXXXXXXXXXX
```

#### 2.1.2、多库多表实现

```yaml
分表策略：单字段Hash算法，多字段复杂算法
分库策略：单字段Hash算法，多字段复杂算法

ds1:
  -table_1
  .
  .
  .
  -table_N

ds2:
  -table_1
  .
  .
  .
  -table_N

ShardingRule: 

	DatabaseRule: XXXXXXXXXXXXXXXX

	TableRule:    XXXXXXXXXXXXXXXX
```

#### 2.1.3、分片原则

	保证均匀：数据分片均匀（分片键和算法的选择，因业务而已）
	考虑增长：当前分片规则和数据库容量是否满足，是否支持横向扩容（固定分片与动态分片）

#### 2.1.4、数据ID唯一性

	客户端保证ID唯一 => SnowFlake、UUID、业务定义（多个字段Hash值）

#### 2.1.5、数据查询

	单条查询 =>（单片键单条查询 A = > C，多片键单条查询 A => B => C ）
	列表查询 => 限制搜索范围（条件）/ 借助全文搜索引擎

-------------------------------------------------------------------------



### 2.2、读写分离



#### 2.2.1、读写配置

```yaml
ds_master:
  -table_1
  .
  .
  .
  -table_N

ds_slave:
  -table_1
  .
  .
  .
  -table_N

ShardingRule: 

	MasterSlaveRule: XXXXXXXXXXXXXXXXXX
```

#### 2.2.2、读写分离方法

	配置数据库主从复制，由客户端实现读写分离

#### 2.2.3、读写分离实现

	三种方式：手动编码实现、中间件配置指定、数据库代理服务解析Sql语法

-------------------------------------------------------------------------



### 2.3、分片+读写分离



#### 2.3.1、分片和读写分离配置
```yaml
	ds1:              
	  -table_1
	  .
	  .
	  .
	  -table_N
	
	ds1_slave:
	  -table_1
	  .
	  .
	  .
	  -table_N
	ds2:
	  -table_1
	  .
	  .
	  .
	  -table_N
	
	ds2_slave:
	  -table_1
	  .
	  .
	  .
	  -table_N
	
	ShardingRule: 
	
		DatabaseRule:    XXXXXXXXXXXXXXXX
	
		TableRule:       XXXXXXXXXXXXXXXX
	
		MasterSlaveRule: XXXXXXXXXXXXXXXXXX
```


#### 2.3.2、分片和读写分离测试

```
验证分片结果和主从结果
```



-------------------------------------------------------------------------





## 三、数据加解密方法实现





-------------------------------------------------------------------------

### 3.1、数据加密



#### 3.1.1、解密配置

```yaml
ds:
  -table_1
  .
  .
  .
  -table_N

ShardingRule: 

	EncryptRule: XXXXXXXXXXXX
```

#### 3.1.2、新旧数据兼容

	数据接口测试

#### 3.1.3、数据加密工具

	简单介绍 + 配置

-------------------------------------------------------------------------



### 3.2、加密+分片



#### 3.2.1、数据加密配置

```yaml
ds1:
  -table_1
  .
  .
  .
  -table_N

ds2:
  -table_1
  .
  .
  .
  -table_N

ShardingRule:

	DatabaseRule: 	XXXXXXXXXXXXXXXX

	TableRule: 		XXXXXXXXXXXXXXXX

	EncryptRule: 	XXXXXXXXXXXX
```

#### 3.2.2、数据加密和分片测试

	测试数据加密和分片结果

-------------------------------------------------------------------------



### 3.3、加密+分片+读写分离



#### 3.3.1、完整结构介绍

```yaml
ds1:              
  -table_1
  .
  .
  .
  -table_N

ds1_slave:
  -table_1
  .
  .
  .
  -table_N
ds2:
  -table_1
  .
  .
  .
  -table_N

ds2_slave:
  -table_1
  .
  .
  .
  -table_N

ShardingRule: 

	DatabaseRule: 		XXXXXXXXXXXXXXXX

	TableRule: 			XXXXXXXXXXXXXXXX

	MasterSlaveRule: 	XXXXXXXXXXXXXXXXXX

	EncryptRule: 		XXXXXXXXXXXX
```



#### 3.3.2、结果验证和测试

	完整测试加密+分片+读写分离结果

-------------------------------------------------------------------------



### 3.4、数据加密脱敏



#### 3.4.1、数据脱敏简介

	联系：二者都是防止敏感数据泄露，导致数据安全事件
	
	区别：从可读性来讲，脱敏数据仍然便于使用，加密数据使得数据不可读
		  从数据算法来讲，脱敏属于不可逆的过程，加密属于可逆的过程

#### 3.4.2、加密算法OR脱敏算法

```
MD5是否属于加密算法？Base64是否属于加密算法？MD5是否可以用来做脱敏？
```

#### 3.4.3、数据脱敏框架简介

	通过工具类调用或者序列化框架实现，目前提供FastJson、Jackson的配置方式
	这两种配置支持注解配置和全局配置，最终效果就是数据按照一定的要求输出
	到页面显示

-------------------------------------------------------------------------





## 四、历史数据分片、迁移、加密



-------------------------------------------------------------------------

### 4.1、历史数据分片



#### 4.1.1、时间+片键

	可以考虑 = > 时间（或某种规则） + 片键，需要引入三方搜索服务解决搜索问题，设计全局ID
	（可以推出大概时间或某种规则），单个查询时，先判断ID规则，是否满足新规则，若满足走
	新库/新表查询，若不满足则查旧库/旧表

#### 4.1.2、二次分片 

	数据迁移，解决倾斜问题（针对部分的数据表或库）
	
	该方法不建议使用，除非数据量已不能承载或数据必须迁移

#### 4.1.3、其它方法

	还有什么方法？或该方法有何问题？

-------------------------------------------------------------------------



### 4.2、历史数据迁移



#### 4.2.1、迁移之前

```
是否需要迁移，分片键设计有问题
```

#### 4.2.4、迁移之后

- 解决数据倾斜、查询、搜索

	倾斜：设计合适的分片键
	搜索：引入三方搜索服务解决搜索
	查询：新增表，使用新规则映射 旧ID映射新ID，使用关联ID，增加一次查询



#### 4.2.3、其它方法



-------------------------------------------------------------------------

### 4.3、历史数据清洗


	设计思路：根据需求来定 -> 通用设计  -> 只用一次 -> 需要操作简单 -> 能看任务进度 -> 能查询验证



-------------------------------------------------------------------------





## 五、动态分片、配置



-------------------------------------------------------------------------



### 5.1、数据库治理


	数据库配置 => 修改规则，刷新到集群，即时生效  <= 该方法生产风险高
	数据库注册 => 放运行时的动态/临时状态数据，比如需要禁用或熔断的datasource实例 <= 不成熟



### 5.2、实现方式

	对于数据增长，业务增长的场景，可以约定使用时间来确定数据源，此时不能再使用配置方式进行配置，
	需编写Java代码创建数据源，以及以上提到的各种用法，否则只能依赖数据库治理服务来修改配置
	
	备注、该部分内容可以参考以下链接：
	
	https://shardingsphere.apache.org/document/current/cn/manual/sharding-jdbc/configuration/config-java/



### 5.3、最佳实践

	动态分片的最佳实践是，通过Java代码的方式，配置相关的分片，读写分离，加解密，然后提供动态的配置能力，
	由于官方文档和配置比较繁琐，所以我们需要简化官方配置文件，提供基础的数据集成工具包，降低集成成本，
	提高该框架的扩展性，这也是Sharding-JDBC 官方开发数据库治理的原因之一，不幸的是，官方的数据库治理功能
	比较鸡肋，没有从根本上解决问题

​		

--------------------


​		